name: Build Simple Release

on:
  push:
    tags:
      - 'simple-v*'
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Build Windows executable
      run: |
        echo "Building Windows version from wopan_web.py..."
        pyinstaller --onefile --name=WoPanWeb --add-data="templates;templates" --add-data="static;static" --add-data="README_WEB.md;." --hidden-import=flask --hidden-import=requests --hidden-import=Crypto.Cipher.AES --hidden-import=Crypto.Util.Padding --hidden-import=werkzeug --hidden-import=jinja2 --hidden-import=markupsafe --hidden-import=itsdangerous --hidden-import=click --console --clean wopan_web.py

    - name: Verify build
      run: |
        echo "Build completed, checking dist directory:"
        dir dist

    - name: Create release package
      run: |
        mkdir release-temp
        copy dist\WoPanWeb.exe release-temp\
        copy README_WEB.md release-temp\
        echo "# è”é€šç½‘ç›˜Webç‰ˆ - Windowsç‰ˆæœ¬" > release-temp\README.txt
        echo "" >> release-temp\README.txt
        echo "ä½¿ç”¨æ–¹æ³•:" >> release-temp\README.txt
        echo "1. åŒå‡» WoPanWeb.exe å¯åŠ¨ç¨‹åº" >> release-temp\README.txt
        echo "2. ç¨‹åºä¼šè‡ªåŠ¨æ‰“å¼€æµè§ˆå™¨" >> release-temp\README.txt
        echo "3. è¾“å…¥Tokenå¼€å§‹ä½¿ç”¨" >> release-temp\README.txt
        
        # åˆ›å»ºZIPåŒ…
        Compress-Archive -Path release-temp\* -DestinationPath WoPanWeb-windows-x64.zip

    - name: Upload artifact
      uses: actions/upload-artifact@v3
      with:
        name: windows-build
        path: WoPanWeb-windows-x64.zip

    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: WoPanWeb-windows-x64.zip
        name: è”é€šç½‘ç›˜Webç‰ˆ ${{ github.ref_name }}
        body: |
          # è”é€šç½‘ç›˜Webç‰ˆ - Windowsç‰ˆæœ¬
          
          ## ğŸ“¦ ä¸‹è½½
          - **Windows 64ä½**: `WoPanWeb-windows-x64.zip`
          
          ## ğŸš€ ä½¿ç”¨æ–¹æ³•
          1. ä¸‹è½½å¹¶è§£å‹ `WoPanWeb-windows-x64.zip`
          2. åŒå‡»è¿è¡Œ `WoPanWeb.exe`
          3. ç¨‹åºä¼šè‡ªåŠ¨æ‰“å¼€æµè§ˆå™¨
          4. è¾“å…¥è”é€šç½‘ç›˜Tokenå¼€å§‹ä½¿ç”¨
          
          ## âœ¨ åŠŸèƒ½ç‰¹æ€§
          - ğŸŒ ç°ä»£åŒ–Webç•Œé¢
          - ğŸ“ æ–‡ä»¶æµè§ˆå’Œç®¡ç†
          - â¬†ï¸ å¤šç§ä¸Šä¼ æ–¹å¼ï¼ˆå•æ–‡ä»¶ã€å¤šæ–‡ä»¶ã€æ–‡ä»¶å¤¹ã€æ‹–æ‹½ï¼‰
          - â¬‡ï¸ ä¸€é”®è·å–ä¸‹è½½é“¾æ¥
          - ğŸ—‚ï¸ åˆ›å»º/åˆ é™¤æ–‡ä»¶å¤¹
          - ğŸµ ç”Ÿæˆæ’­æ”¾åˆ—è¡¨ï¼ˆæ”¯æŒURLç¼–ç ï¼‰
          - ğŸ”— URLç¼–ç è·¯å¾„ï¼ˆè§£å†³ä¸­æ–‡è·¯å¾„é—®é¢˜ï¼‰
          
          ## ğŸ”‘ Tokenè·å–æ–¹æ³•
          1. ç™»å½• [è”é€šç½‘ç›˜ç½‘é¡µç‰ˆ](https://pan.wo.cn)
          2. æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…· (F12)
          3. åœ¨ç½‘ç»œè¯·æ±‚ä¸­æ‰¾åˆ°åŒ…å« `Accesstoken` çš„è¯·æ±‚å¤´
          4. å¤åˆ¶Tokenå€¼åˆ°ç¨‹åºä¸­ä½¿ç”¨
          
          ## âš ï¸ æ³¨æ„äº‹é¡¹
          - é¦–æ¬¡è¿è¡Œå¯èƒ½éœ€è¦å‡ ç§’é’Ÿå¯åŠ¨æ—¶é—´
          - è¯·å…è®¸é˜²ç«å¢™è®¿é—®ç½‘ç»œ
          - Tokenè¯·å¦¥å–„ä¿ç®¡ï¼Œä¸è¦æ³„éœ²
        draft: false
        prerelease: false
        token: ${{ secrets.GITHUB_TOKEN }}
