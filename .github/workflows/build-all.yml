name: Build All Platforms

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: windows-latest
            platform: windows
            arch: x64
            executable_name: WoPanWeb.exe
            package_name: WoPanWeb-windows-x64.zip
          - os: macos-latest
            platform: macos
            arch: x64
            executable_name: WoPanWeb
            package_name: WoPanWeb-macos-x64.tar.gz

    runs-on: ${{ matrix.os }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Verify files (Windows)
      if: matrix.platform == 'windows'
      run: |
        echo "Checking required files..."
        dir
        echo "Checking wopan_web.py:"
        type wopan_web.py | findstr /n "^" | findstr /c:"1:" /c:"2:" /c:"3:" /c:"4:" /c:"5:"
        echo "Checking templates directory:"
        dir templates
        echo "Checking static directory:"
        dir static

    - name: Verify files (macOS)
      if: matrix.platform == 'macos'
      run: |
        echo "Checking required files..."
        ls -la
        echo "Checking wopan_web.py:"
        head -5 wopan_web.py
        echo "Checking templates directory:"
        ls -la templates/
        echo "Checking static directory:"
        ls -la static/

    - name: Build executable (Windows)
      if: matrix.platform == 'windows'
      run: |
        echo "Building Windows version..."
        pyinstaller --onefile --name=WoPanWeb --add-data="templates;templates" --add-data="static;static" --add-data="README_WEB.md;." --hidden-import=flask --hidden-import=requests --hidden-import=Crypto.Cipher.AES --hidden-import=Crypto.Util.Padding --hidden-import=werkzeug --hidden-import=jinja2 --hidden-import=markupsafe --hidden-import=itsdangerous --hidden-import=click --hidden-import=socket --hidden-import=webbrowser --hidden-import=threading --hidden-import=time --hidden-import=uuid --hidden-import=tempfile --hidden-import=shutil --hidden-import=hashlib --hidden-import=random --hidden-import=base64 --hidden-import=json --hidden-import=os --hidden-import=sys --console --clean main.py

    - name: Build executable (macOS)
      if: matrix.platform == 'macos'
      run: |
        echo "Building macOS version..."
        pyinstaller \
          --onefile \
          --name=WoPanWeb \
          --add-data="templates:templates" \
          --add-data="static:static" \
          --add-data="README_WEB.md:." \
          --hidden-import=flask \
          --hidden-import=requests \
          --hidden-import=Crypto.Cipher.AES \
          --hidden-import=Crypto.Util.Padding \
          --hidden-import=werkzeug \
          --hidden-import=jinja2 \
          --hidden-import=markupsafe \
          --hidden-import=itsdangerous \
          --hidden-import=click \
          --hidden-import=socket \
          --hidden-import=webbrowser \
          --hidden-import=threading \
          --hidden-import=time \
          --hidden-import=uuid \
          --hidden-import=tempfile \
          --hidden-import=shutil \
          --hidden-import=hashlib \
          --hidden-import=random \
          --hidden-import=base64 \
          --hidden-import=json \
          --hidden-import=os \
          --hidden-import=sys \
          --console \
          --clean \
          main.py

    - name: Verify build
      run: |
        echo "Build completed, checking dist directory:"
        ls -la dist/ || dir dist

    - name: Create release package (Windows)
      if: matrix.platform == 'windows'
      run: |
        if (-not (Test-Path "release")) { mkdir release }
        copy dist\WoPanWeb.exe release\
        copy README_WEB.md release\
        copy requirements.txt release\
        echo "# è”é€šç½‘ç›˜Webç‰ˆ - Windowsç‰ˆæœ¬" > release\README.txt
        echo "" >> release\README.txt
        echo "ä½¿ç”¨æ–¹æ³•:" >> release\README.txt
        echo "1. åŒå‡» WoPanWeb.exe å¯åŠ¨ç¨‹åº" >> release\README.txt
        echo "2. ç¨‹åºä¼šè‡ªåŠ¨æ‰“å¼€æµè§ˆå™¨" >> release\README.txt
        echo "3. è¾“å…¥Tokenå¼€å§‹ä½¿ç”¨" >> release\README.txt
        echo "" >> release\README.txt
        echo "åŠŸèƒ½ç‰¹æ€§:" >> release\README.txt
        echo "- æ–‡ä»¶æµè§ˆå’Œç®¡ç†" >> release\README.txt
        echo "- å¤šç§ä¸Šä¼ æ–¹å¼" >> release\README.txt
        echo "- è·å–ä¸‹è½½é“¾æ¥" >> release\README.txt
        echo "- ç”Ÿæˆæ’­æ”¾åˆ—è¡¨" >> release\README.txt
        
        # åˆ›å»ºZIPåŒ…
        Compress-Archive -Path release\* -DestinationPath ${{ matrix.package_name }}

    - name: Create release package (macOS)
      if: matrix.platform == 'macos'
      run: |
        mkdir -p release
        cp dist/WoPanWeb release/
        cp README_WEB.md release/
        cp requirements.txt release/
        echo "# è”é€šç½‘ç›˜Webç‰ˆ - macOSç‰ˆæœ¬" > release/README.txt
        echo "" >> release/README.txt
        echo "ä½¿ç”¨æ–¹æ³•:" >> release/README.txt
        echo "1. æ‰“å¼€ç»ˆç«¯ï¼Œè¿›å…¥ç¨‹åºç›®å½•" >> release/README.txt
        echo "2. è®¾ç½®æƒé™: chmod +x WoPanWeb" >> release/README.txt
        echo "3. è¿è¡Œç¨‹åº: ./WoPanWeb" >> release/README.txt
        echo "4. ç¨‹åºä¼šè‡ªåŠ¨æ‰“å¼€æµè§ˆå™¨" >> release/README.txt
        echo "" >> release/README.txt
        echo "åŠŸèƒ½ç‰¹æ€§:" >> release/README.txt
        echo "- æ–‡ä»¶æµè§ˆå’Œç®¡ç†" >> release/README.txt
        echo "- å¤šç§ä¸Šä¼ æ–¹å¼" >> release/README.txt
        echo "- è·å–ä¸‹è½½é“¾æ¥" >> release/README.txt
        echo "- ç”Ÿæˆæ’­æ”¾åˆ—è¡¨" >> release/README.txt
        echo "" >> release/README.txt
        echo "æ³¨æ„äº‹é¡¹:" >> release/README.txt
        echo "- é¦–æ¬¡è¿è¡Œå¯èƒ½éœ€è¦åœ¨ç³»ç»Ÿåå¥½è®¾ç½®ä¸­å…è®¸" >> release/README.txt
        echo "- å¦‚é‡å®‰å…¨æç¤ºï¼Œè¯·åœ¨'å®‰å…¨æ€§ä¸éšç§'ä¸­ç‚¹å‡»'ä»è¦æ‰“å¼€'" >> release/README.txt
        
        # åˆ›å»ºTAR.GZåŒ…
        cd release
        tar -czf ../${{ matrix.package_name }} *
        cd ..

    - name: Upload artifact
      uses: actions/upload-artifact@v3
      with:
        name: ${{ matrix.platform }}-build
        path: ${{ matrix.package_name }}

    - name: Upload to Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: ${{ matrix.package_name }}
        name: è”é€šç½‘ç›˜Webç‰ˆ ${{ github.ref_name }}
        body: |
          # è”é€šç½‘ç›˜Webç‰ˆ - è·¨å¹³å°å‘å¸ƒ

          ## ğŸ“¦ ä¸‹è½½è¯´æ˜
          - **Windows 64ä½**: `WoPanWeb-windows-x64.zip`
          - **macOS Intel/Apple Silicon**: `WoPanWeb-macos-x64.tar.gz`

          ## ğŸš€ ä½¿ç”¨æ–¹æ³•

          ### Windowsç”¨æˆ·
          1. ä¸‹è½½å¹¶è§£å‹ `WoPanWeb-windows-x64.zip`
          2. åŒå‡»è¿è¡Œ `WoPanWeb.exe`
          3. ç¨‹åºä¼šè‡ªåŠ¨æ‰“å¼€æµè§ˆå™¨

          ### macOSç”¨æˆ·
          1. ä¸‹è½½å¹¶è§£å‹ `WoPanWeb-macos-x64.tar.gz`
          2. æ‰“å¼€ç»ˆç«¯ï¼Œè¿›å…¥è§£å‹ç›®å½•
          3. è¿è¡Œ: `chmod +x WoPanWeb && ./WoPanWeb`
          4. ç¨‹åºä¼šè‡ªåŠ¨æ‰“å¼€æµè§ˆå™¨

          ## âœ¨ æ–°åŠŸèƒ½ç‰¹æ€§
          - ğŸŒ ç°ä»£åŒ–Webç•Œé¢
          - ğŸ“ æ–‡ä»¶æµè§ˆå’Œç®¡ç†
          - â¬†ï¸ å¤šç§ä¸Šä¼ æ–¹å¼ï¼ˆå•æ–‡ä»¶ã€å¤šæ–‡ä»¶ã€æ–‡ä»¶å¤¹ã€æ‹–æ‹½ï¼‰
          - â¬‡ï¸ ä¸€é”®è·å–ä¸‹è½½é“¾æ¥
          - ğŸ—‚ï¸ åˆ›å»º/åˆ é™¤æ–‡ä»¶å¤¹
          - ğŸµ ç”Ÿæˆæ’­æ”¾åˆ—è¡¨ï¼ˆæ”¯æŒURLç¼–ç ï¼‰
          - ğŸ”— URLç¼–ç è·¯å¾„ï¼ˆè§£å†³ä¸­æ–‡è·¯å¾„é—®é¢˜ï¼‰

          ## ğŸ”‘ Tokenè·å–
          1. ç™»å½• [è”é€šç½‘ç›˜ç½‘é¡µç‰ˆ](https://pan.wo.cn)
          2. æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…· (F12)
          3. åœ¨ç½‘ç»œè¯·æ±‚ä¸­æ‰¾åˆ°åŒ…å« `Accesstoken` çš„è¯·æ±‚å¤´
          4. å¤åˆ¶Tokenå€¼ä½¿ç”¨

          ## âš ï¸ æ³¨æ„äº‹é¡¹
          - é¦–æ¬¡è¿è¡Œå¯èƒ½éœ€è¦å‡ ç§’é’Ÿå¯åŠ¨æ—¶é—´
          - Windowsç”¨æˆ·è¯·å…è®¸é˜²ç«å¢™è®¿é—®
          - macOSç”¨æˆ·é¦–æ¬¡è¿è¡Œå¯èƒ½éœ€è¦åœ¨ç³»ç»Ÿåå¥½è®¾ç½®ä¸­å…è®¸
        draft: false
        prerelease: false
        token: ${{ secrets.GITHUB_TOKEN }}
