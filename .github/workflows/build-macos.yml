name: Build macOS Version

on:
  push:
    tags:
      - 'macos-v*'
  workflow_dispatch:

jobs:
  build-macos:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Verify files
      run: |
        echo "Checking required files..."
        ls -la
        echo "Checking wopan_web.py:"
        head -10 wopan_web.py
        echo "Checking templates directory:"
        ls -la templates/
        echo "Checking static directory:"
        ls -la static/

    - name: Build macOS executable
      run: |
        echo "Building macOS version..."
        pyinstaller \
          --onefile \
          --name=WoPanWeb \
          --add-data="templates:templates" \
          --add-data="static:static" \
          --add-data="README_WEB.md:." \
          --hidden-import=flask \
          --hidden-import=requests \
          --hidden-import=Crypto.Cipher.AES \
          --hidden-import=Crypto.Util.Padding \
          --hidden-import=werkzeug \
          --hidden-import=jinja2 \
          --hidden-import=markupsafe \
          --hidden-import=itsdangerous \
          --hidden-import=click \
          --hidden-import=socket \
          --hidden-import=webbrowser \
          --hidden-import=threading \
          --hidden-import=time \
          --hidden-import=uuid \
          --hidden-import=tempfile \
          --hidden-import=shutil \
          --hidden-import=hashlib \
          --hidden-import=random \
          --hidden-import=base64 \
          --hidden-import=json \
          --hidden-import=os \
          --hidden-import=sys \
          --console \
          --clean \
          main.py

    - name: Verify build
      run: |
        echo "Build completed, checking dist directory:"
        ls -la dist/
        echo "Testing executable:"
        ./dist/WoPanWeb --help || echo "Executable created successfully"

    - name: Create release package
      run: |
        mkdir -p release
        cp dist/WoPanWeb release/
        cp README_WEB.md release/
        cp requirements.txt release/
        echo "# è”é€šç½‘ç›˜Webç‰ˆ - macOSç‰ˆæœ¬" > release/README.txt
        echo "" >> release/README.txt
        echo "è¿è¡Œæ–¹æ³•:" >> release/README.txt
        echo "1. æ‰“å¼€ç»ˆç«¯" >> release/README.txt
        echo "2. è¿›å…¥ç¨‹åºç›®å½•" >> release/README.txt
        echo "3. è¿è¡Œ: ./WoPanWeb" >> release/README.txt
        echo "4. ç¨‹åºä¼šè‡ªåŠ¨æ‰“å¼€æµè§ˆå™¨" >> release/README.txt
        echo "" >> release/README.txt
        echo "å¦‚æœé‡åˆ°æƒé™é—®é¢˜ï¼Œè¯·è¿è¡Œ: chmod +x WoPanWeb" >> release/README.txt

    - name: Create archive
      run: |
        cd release
        tar -czf ../WoPanWeb-macos-x64.tar.gz *
        cd ..
        ls -la WoPanWeb-macos-x64.tar.gz

    - name: Upload artifact
      uses: actions/upload-artifact@v3
      with:
        name: WoPanWeb-macos-x64
        path: WoPanWeb-macos-x64.tar.gz

    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: WoPanWeb-macos-x64.tar.gz
        name: è”é€šç½‘ç›˜Webç‰ˆ macOS ${{ github.ref_name }}
        body: |
          # è”é€šç½‘ç›˜Webç‰ˆ - macOSç‰ˆæœ¬
          
          ## ä¸‹è½½è¯´æ˜
          - **macOS Intel/Apple Silicon**: `WoPanWeb-macos-x64.tar.gz`
          
          ## ä½¿ç”¨æ–¹æ³•
          1. ä¸‹è½½å¹¶è§£å‹ `WoPanWeb-macos-x64.tar.gz`
          2. æ‰“å¼€ç»ˆç«¯ï¼Œè¿›å…¥è§£å‹åçš„ç›®å½•
          3. è¿è¡Œæƒé™è®¾ç½®: `chmod +x WoPanWeb`
          4. å¯åŠ¨ç¨‹åº: `./WoPanWeb`
          5. ç¨‹åºä¼šè‡ªåŠ¨æ‰“å¼€æµè§ˆå™¨
          
          ## åŠŸèƒ½ç‰¹æ€§
          - ğŸŒ ç°ä»£åŒ–Webç•Œé¢
          - ğŸ“ æ–‡ä»¶æµè§ˆå’Œç®¡ç†
          - â¬†ï¸ å¤šç§ä¸Šä¼ æ–¹å¼
          - â¬‡ï¸ è·å–ä¸‹è½½é“¾æ¥
          - ğŸµ ç”Ÿæˆæ’­æ”¾åˆ—è¡¨
          
          ## æ³¨æ„äº‹é¡¹
          - é¦–æ¬¡è¿è¡Œå¯èƒ½éœ€è¦åœ¨ç³»ç»Ÿåå¥½è®¾ç½®ä¸­å…è®¸è¿è¡Œ
          - å¦‚é‡åˆ°å®‰å…¨æç¤ºï¼Œè¯·åœ¨"å®‰å…¨æ€§ä¸éšç§"ä¸­ç‚¹å‡»"ä»è¦æ‰“å¼€"
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
