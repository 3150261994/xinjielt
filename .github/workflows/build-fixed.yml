name: Build Fixed Release

on:
  push:
    tags:
      - 'fixed-v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Build Windows executable
      run: |
        echo "Building Windows version from wopan_web.py..."
        pyinstaller --onefile --name=WoPanWeb --add-data="templates;templates" --add-data="static;static" --add-data="README_WEB.md;." --hidden-import=flask --hidden-import=requests --hidden-import=Crypto.Cipher.AES --hidden-import=Crypto.Util.Padding --hidden-import=werkzeug --hidden-import=jinja2 --hidden-import=markupsafe --hidden-import=itsdangerous --hidden-import=click --console --clean wopan_web.py

    - name: Create Windows package
      run: |
        mkdir release-win
        copy dist\WoPanWeb.exe release-win\
        copy README_WEB.md release-win\
        echo "# 联通网盘Web版 - Windows版本" > release-win\README.txt
        echo "" >> release-win\README.txt
        echo "使用方法:" >> release-win\README.txt
        echo "1. 双击 WoPanWeb.exe 启动程序" >> release-win\README.txt
        echo "2. 访问 http://localhost:5000" >> release-win\README.txt
        echo "3. 输入Token开始使用" >> release-win\README.txt
        
        Compress-Archive -Path release-win\* -DestinationPath WoPanWeb-windows-x64.zip

    - name: Upload Windows artifact
      uses: actions/upload-artifact@v3
      with:
        name: windows-package
        path: WoPanWeb-windows-x64.zip

  build-macos:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Build macOS executable
      run: |
        echo "Building macOS version from wopan_web.py..."
        pyinstaller --onefile --name=WoPanWeb --add-data="templates:templates" --add-data="static:static" --add-data="README_WEB.md:." --hidden-import=flask --hidden-import=requests --hidden-import=Crypto.Cipher.AES --hidden-import=Crypto.Util.Padding --hidden-import=werkzeug --hidden-import=jinja2 --hidden-import=markupsafe --hidden-import=itsdangerous --hidden-import=click --console --clean wopan_web.py

    - name: Create macOS package
      run: |
        mkdir release-mac
        cp dist/WoPanWeb release-mac/
        cp README_WEB.md release-mac/
        echo "# 联通网盘Web版 - macOS版本" > release-mac/README.txt
        echo "" >> release-mac/README.txt
        echo "使用方法:" >> release-mac/README.txt
        echo "1. 打开终端，进入程序目录" >> release-mac/README.txt
        echo "2. 运行: chmod +x WoPanWeb" >> release-mac/README.txt
        echo "3. 启动: ./WoPanWeb" >> release-mac/README.txt
        echo "4. 访问 http://localhost:5000" >> release-mac/README.txt
        
        cd release-mac
        tar -czf ../WoPanWeb-macos-x64.tar.gz *
        cd ..

    - name: Upload macOS artifact
      uses: actions/upload-artifact@v3
      with:
        name: macos-package
        path: WoPanWeb-macos-x64.tar.gz

  create-release:
    needs: [build-windows, build-macos]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: Download Windows artifact
      uses: actions/download-artifact@v3
      with:
        name: windows-package

    - name: Download macOS artifact
      uses: actions/download-artifact@v3
      with:
        name: macos-package

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          WoPanWeb-windows-x64.zip
          WoPanWeb-macos-x64.tar.gz
        name: 联通网盘Web版 ${{ github.ref_name }}
        body: |
          # 联通网盘Web版 - 跨平台发布
          
          ## 📦 下载说明
          - **Windows 64位**: `WoPanWeb-windows-x64.zip`
          - **macOS Intel/Apple Silicon**: `WoPanWeb-macos-x64.tar.gz`
          
          ## 🚀 使用方法
          
          ### Windows用户
          1. 下载并解压 `WoPanWeb-windows-x64.zip`
          2. 双击运行 `WoPanWeb.exe`
          3. 访问 `http://localhost:5000`
          
          ### macOS用户
          1. 下载并解压 `WoPanWeb-macos-x64.tar.gz`
          2. 打开终端，进入解压目录
          3. 运行: `chmod +x WoPanWeb && ./WoPanWeb`
          4. 访问 `http://localhost:5000`
          
          ## ✨ 功能特性
          - 🌐 现代化Web界面
          - 📁 文件浏览和管理
          - ⬆️ 多种上传方式（单文件、多文件、文件夹、拖拽）
          - ⬇️ 一键获取下载链接
          - 🗂️ 创建/删除文件夹
          - 🎵 生成播放列表（支持URL编码）
          - 🔗 URL编码路径（解决中文路径问题）
          
          ## 🔑 Token获取方法
          1. 登录 [联通网盘网页版](https://pan.wo.cn)
          2. 打开浏览器开发者工具 (F12)
          3. 在网络请求中找到包含 `Accesstoken` 的请求头
          4. 复制Token值到程序中使用
        draft: false
        prerelease: false
