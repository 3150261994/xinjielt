name: Build Fixed Release

on:
  push:
    tags:
      - 'fixed-v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Build Windows executable
      run: |
        echo "Building Windows version from wopan_web.py..."
        pyinstaller --onefile --name=WoPanWeb --add-data="templates;templates" --add-data="static;static" --add-data="README_WEB.md;." --hidden-import=flask --hidden-import=requests --hidden-import=Crypto.Cipher.AES --hidden-import=Crypto.Util.Padding --hidden-import=werkzeug --hidden-import=jinja2 --hidden-import=markupsafe --hidden-import=itsdangerous --hidden-import=click --console --clean wopan_web.py

    - name: Create Windows package
      run: |
        mkdir release-win
        copy dist\WoPanWeb.exe release-win\
        copy README_WEB.md release-win\
        echo "# è”é€šç½‘ç›˜Webç‰ˆ - Windowsç‰ˆæœ¬" > release-win\README.txt
        echo "" >> release-win\README.txt
        echo "ä½¿ç”¨æ–¹æ³•:" >> release-win\README.txt
        echo "1. åŒå‡» WoPanWeb.exe å¯åŠ¨ç¨‹åº" >> release-win\README.txt
        echo "2. è®¿é—® http://localhost:5000" >> release-win\README.txt
        echo "3. è¾“å…¥Tokenå¼€å§‹ä½¿ç”¨" >> release-win\README.txt
        
        Compress-Archive -Path release-win\* -DestinationPath WoPanWeb-windows-x64.zip

    - name: Upload Windows artifact
      uses: actions/upload-artifact@v3
      with:
        name: windows-package
        path: WoPanWeb-windows-x64.zip

  build-macos:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Build macOS executable
      run: |
        echo "Building macOS version from wopan_web.py..."
        pyinstaller --onefile --name=WoPanWeb --add-data="templates:templates" --add-data="static:static" --add-data="README_WEB.md:." --hidden-import=flask --hidden-import=requests --hidden-import=Crypto.Cipher.AES --hidden-import=Crypto.Util.Padding --hidden-import=werkzeug --hidden-import=jinja2 --hidden-import=markupsafe --hidden-import=itsdangerous --hidden-import=click --console --clean wopan_web.py

    - name: Create macOS package
      run: |
        mkdir release-mac
        cp dist/WoPanWeb release-mac/
        cp README_WEB.md release-mac/
        echo "# è”é€šç½‘ç›˜Webç‰ˆ - macOSç‰ˆæœ¬" > release-mac/README.txt
        echo "" >> release-mac/README.txt
        echo "ä½¿ç”¨æ–¹æ³•:" >> release-mac/README.txt
        echo "1. æ‰“å¼€ç»ˆç«¯ï¼Œè¿›å…¥ç¨‹åºç›®å½•" >> release-mac/README.txt
        echo "2. è¿è¡Œ: chmod +x WoPanWeb" >> release-mac/README.txt
        echo "3. å¯åŠ¨: ./WoPanWeb" >> release-mac/README.txt
        echo "4. è®¿é—® http://localhost:5000" >> release-mac/README.txt
        
        cd release-mac
        tar -czf ../WoPanWeb-macos-x64.tar.gz *
        cd ..

    - name: Upload macOS artifact
      uses: actions/upload-artifact@v3
      with:
        name: macos-package
        path: WoPanWeb-macos-x64.tar.gz

  create-release:
    needs: [build-windows, build-macos]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: Download Windows artifact
      uses: actions/download-artifact@v3
      with:
        name: windows-package

    - name: Download macOS artifact
      uses: actions/download-artifact@v3
      with:
        name: macos-package

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          WoPanWeb-windows-x64.zip
          WoPanWeb-macos-x64.tar.gz
        name: è”é€šç½‘ç›˜Webç‰ˆ ${{ github.ref_name }}
        body: |
          # è”é€šç½‘ç›˜Webç‰ˆ - è·¨å¹³å°å‘å¸ƒ
          
          ## ğŸ“¦ ä¸‹è½½è¯´æ˜
          - **Windows 64ä½**: `WoPanWeb-windows-x64.zip`
          - **macOS Intel/Apple Silicon**: `WoPanWeb-macos-x64.tar.gz`
          
          ## ğŸš€ ä½¿ç”¨æ–¹æ³•
          
          ### Windowsç”¨æˆ·
          1. ä¸‹è½½å¹¶è§£å‹ `WoPanWeb-windows-x64.zip`
          2. åŒå‡»è¿è¡Œ `WoPanWeb.exe`
          3. è®¿é—® `http://localhost:5000`
          
          ### macOSç”¨æˆ·
          1. ä¸‹è½½å¹¶è§£å‹ `WoPanWeb-macos-x64.tar.gz`
          2. æ‰“å¼€ç»ˆç«¯ï¼Œè¿›å…¥è§£å‹ç›®å½•
          3. è¿è¡Œ: `chmod +x WoPanWeb && ./WoPanWeb`
          4. è®¿é—® `http://localhost:5000`
          
          ## âœ¨ åŠŸèƒ½ç‰¹æ€§
          - ğŸŒ ç°ä»£åŒ–Webç•Œé¢
          - ğŸ“ æ–‡ä»¶æµè§ˆå’Œç®¡ç†
          - â¬†ï¸ å¤šç§ä¸Šä¼ æ–¹å¼ï¼ˆå•æ–‡ä»¶ã€å¤šæ–‡ä»¶ã€æ–‡ä»¶å¤¹ã€æ‹–æ‹½ï¼‰
          - â¬‡ï¸ ä¸€é”®è·å–ä¸‹è½½é“¾æ¥
          - ğŸ—‚ï¸ åˆ›å»º/åˆ é™¤æ–‡ä»¶å¤¹
          - ğŸµ ç”Ÿæˆæ’­æ”¾åˆ—è¡¨ï¼ˆæ”¯æŒURLç¼–ç ï¼‰
          - ğŸ”— URLç¼–ç è·¯å¾„ï¼ˆè§£å†³ä¸­æ–‡è·¯å¾„é—®é¢˜ï¼‰
          
          ## ğŸ”‘ Tokenè·å–æ–¹æ³•
          1. ç™»å½• [è”é€šç½‘ç›˜ç½‘é¡µç‰ˆ](https://pan.wo.cn)
          2. æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…· (F12)
          3. åœ¨ç½‘ç»œè¯·æ±‚ä¸­æ‰¾åˆ°åŒ…å« `Accesstoken` çš„è¯·æ±‚å¤´
          4. å¤åˆ¶Tokenå€¼åˆ°ç¨‹åºä¸­ä½¿ç”¨
        draft: false
        prerelease: false
